!function(e){"use strict";window.AudioContext&&function(){var n,t=!1,o=e.WebAudio={api:"webaudio"},i={},a={},r=127,u={};o.audioBuffers=u,o.send=function(e,n){},o.setController=function(e,n,t,o){},o.setVolume=function(e,n,t){t?setTimeout(function(){r=n},1e3*t):r=n},o.programChange=function(n,t,o){e.channels[n].instrument=t},o.pitchBend=function(n,t,o){e.channels[n].pitchBend=t},o.noteOn=function(o,f,c,s){s=s||0;var d=e.channels[o].instrument,l=u[d+""+f];if(l){if(s<n.currentTime&&(s+=n.currentTime),t)var v=n.createMediaElementSource(l);else(v=n.createBufferSource()).buffer=l;if(a){var m=v;for(var p in a)m.connect(a[p].input),m=a[p]}var T=c/127*(r/127)*2-1;if(v.connect(n.destination),v.playbackRate.value=1,v.gainNode=n.createGain(),v.gainNode.connect(n.destination),v.gainNode.gain.value=Math.min(1,Math.max(-1,T)),v.connect(v.gainNode),t){if(s)return setTimeout(function(){l.currentTime=0,l.play()},1e3*s);l.currentTime=0,l.play()}else v.start(s||0);return i[o+""+f]=v,v}},o.noteOff=function(o,a,r){r=r||0;var f=e.channels[o].instrument,c=u[f+""+a];if(c){r<n.currentTime&&(r+=n.currentTime);var s=i[o+""+a];if(s){if(s.gainNode){var d=s.gainNode.gain;d.linearRampToValueAtTime(d.value,r),d.linearRampToValueAtTime(-1,r+.3)}return t?r?setTimeout(function(){c.pause()},1e3*r):c.pause():s.noteOff?s.noteOff(r+.5):s.stop(r+.5),delete i[o+""+a],s}}},o.chordOn=function(e,n,t,i){for(var a,r={},u=0,f=n.length;u<f;u++)r[a=n[u]]=o.noteOn(e,a,t,i);return r},o.chordOff=function(e,n,t){for(var i,a={},r=0,u=n.length;r<u;r++)a[i=n[r]]=o.noteOff(e,i,t);return a},o.stopAllNotes=function(){for(var e in i){var t=0;t<n.currentTime&&(t+=n.currentTime);var o=i[e];o.gain.linearRampToValueAtTime(1,t),o.gain.linearRampToValueAtTime(0,t+.3),o.noteOff?o.noteOff(t+.3):o.stop(t+.3),delete i[e]}},o.setEffects=function(e){if(!n.tunajs)return console.log("Effects module not installed.");for(var t=0;t<e.length;t++){var o=e[t],i=new n.tunajs[o.type](o);i.connect(n.destination),a[o.type]=i}},o.connect=function(t){e.setDefaultPlugin(o),o.setContext(n||new(window.AudioContext||window.webkitAudioContext),t.onsuccess)},o.getContext=function(){return n},o.setContext=function(o,i,a,r){n=o,"undefined"==typeof Tuna||n.tunajs||(n.tunajs=new Tuna(n));var f=[],c=e.keyToNote;for(var s in c)f.push(s);var d=function(e){for(var n in v)if(v[n])return;i&&(i(),i=null)},l=function(o,i,a,r){var f=o[r];f&&(v[i]++,function(e,o,i){if(t){var a=new Audio;a.src=e,a.controls=!1,a.autoplay=!1,a.preload=!1,a.addEventListener("canplay",function(){o&&o(a)}),a.addEventListener("error",function(e){i&&i(e)}),document.body.appendChild(a)}else if(0===e.indexOf("data:audio")){var r=e.split(",")[1],u=Base64Binary.decodeArrayBuffer(r);n.decodeAudioData(u,o,i)}else{var f=new XMLHttpRequest;f.open("GET",e,!0),f.responseType="arraybuffer",f.onload=function(){n.decodeAudioData(f.response,o,i)},f.send()}}(f,function(n){n.id=r;var t=e.keyToNote[r];if(u[i+""+t]=n,0==--v[i]){o.isLoaded=!0,d()}},function(e){}))},v={};for(var m in e.Soundfont){var p=e.Soundfont[m];if(!p.isLoaded){var T=e.GM.byName[m].number;v[T]=0;for(var g=0;g<f.length;g++){l(p,T,0,s=f[g])}}}setTimeout(d,1)}}()}(MIDI);